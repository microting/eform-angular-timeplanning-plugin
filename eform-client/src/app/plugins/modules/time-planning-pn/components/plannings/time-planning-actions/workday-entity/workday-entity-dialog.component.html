<!-- Reactive: wrap everything in a form -->
<form [formGroup]="workdayForm">
  <div mat-dialog-title>
    {{ data.planningPrDayModels.siteName }} -
    {{ datePipe.transform(data.planningPrDayModels.date, 'dd.MM.yyyy') }}
    ({{ data.planningPrDayModels.id }})
  </div>

  <div mat-dialog-content>
    <br />
    <mtx-grid
      [columns]="tableHeaders"
      [data]="shiftData"
      [showPaginator]="false"
      [pageOnFront]="false"
      [rowStriped]="true"
      [showToolbar]="false"
      [showColumnMenuButton]="false">
    </mtx-grid>

    <!-- PLANNED COLUMN TEMPLATE -->
    <ng-template #plannedColumnTemplate let-row let-col="colDef">
      <!-- SHIFT 1 -->
      <ng-container *ngIf="row['shiftId'] === '1'" [formGroupName]="'planned'">
        <div [formGroupName]="'shift1'">
          <div class="flex-row">
            <mat-form-field>
              <mat-label>{{ 'Start' | translate }}</mat-label>
              <input
                matInput
                readonly
                [ngxTimepicker]="plannedPicker"
                [format]="24"
                formControlName="start"
                id="plannedStartOfShift1" />
              <ngx-material-timepicker
                #plannedPicker
                [format]="24"
                [defaultTime]="workdayForm.get('planned.shift1.start')?.value"
                [minutesGap]="5"
                (closed)="calculatePlanHours()">
              </ngx-material-timepicker>
            </mat-form-field>
            <button mat-icon-button color="warn" (click)="resetPlannedTimes(1)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div class="flex-row">
            <mat-form-field>
              <mat-label>{{ 'Pause' | translate }}</mat-label>
              <input
                matInput
                readonly
                [ngxTimepicker]="plannedPause1Picker"
                [format]="24"
                formControlName="break"
                [min]="'00:00'"
                [max]="getMaxDifference(workdayForm.get('planned.shift1.start')?.value, workdayForm.get('planned.shift1.stop')?.value)"
                id="plannedBreakOfShift1" />
              <ngx-material-timepicker
                #plannedPause1Picker
                [format]="24"
                [defaultTime]="workdayForm.get('planned.shift1.break')?.value"
                [minutesGap]="5"
                (closed)="calculatePlanHours()">
              </ngx-material-timepicker>
            </mat-form-field>
            <button mat-icon-button color="warn" (click)="resetPlannedTimes(2)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div class="flex-row">
            <mat-form-field>
              <mat-label>{{ 'Stop' | translate }}</mat-label>
              <input
                matInput
                readonly
                [ngxTimepicker]="plannedPicker2"
                [format]="24"
                formControlName="stop"
                id="plannedEndOfShift1" />
              <ngx-material-timepicker
                #plannedPicker2
                [format]="24"
                [defaultTime]="workdayForm.get('planned.shift1.stop')?.value"
                [minutesGap]="5"
                (closed)="calculatePlanHours()">
              </ngx-material-timepicker>
            </mat-form-field>
            <button mat-icon-button color="warn" (click)="resetPlannedTimes(3)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </ng-container>

      <!-- SHIFT 2 -->
      <ng-container *ngIf="row['shiftId'] === '2'" [formGroupName]="'planned'">
        <div [formGroupName]="'shift2'">
          <div class="flex-row">
            <mat-form-field>
              <mat-label>{{ 'Start' | translate }}</mat-label>
              <input
                matInput
                readonly
                [ngxTimepicker]="plannedPicker3"
                [format]="24"
                formControlName="start"
                id="plannedStartOfShift2" />
              <ngx-material-timepicker
                #plannedPicker3
                [format]="24"
                [defaultTime]="workdayForm.get('planned.shift2.start')?.value"
                [minutesGap]="5"
                (closed)="calculatePlanHours()">
              </ngx-material-timepicker>
            </mat-form-field>
            <button mat-icon-button color="warn" (click)="resetPlannedTimes(4)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div class="flex-row">
            <mat-form-field>
              <mat-label>{{ 'Pause' | translate }}</mat-label>
              <input
                matInput
                readonly
                [ngxTimepicker]="plannedPause2Picker"
                [format]="24"
                formControlName="break"
                [min]="'00:00'"
                [max]="getMaxDifference(workdayForm.get('planned.shift2.start')?.value, workdayForm.get('planned.shift2.stop')?.value)"
                id="plannedBreakOfShift2" />
              <ngx-material-timepicker
                #plannedPause2Picker
                [format]="24"
                [defaultTime]="workdayForm.get('planned.shift2.break')?.value"
                [minutesGap]="5"
                (closed)="calculatePlanHours()">
              </ngx-material-timepicker>
            </mat-form-field>
            <button mat-icon-button color="warn" (click)="resetPlannedTimes(5)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div class="flex-row">
            <mat-form-field>
              <mat-label>{{ 'Stop' | translate }}</mat-label>
              <input
                matInput
                readonly
                [ngxTimepicker]="plannedPicker4"
                [format]="24"
                formControlName="stop"
                [value]="workdayForm.get('planned.shift2.stop')?.value === '00:00' ? '' : workdayForm.get('planned.shift2.stop')?.value"
                id="plannedEndOfShift2" />
              <ngx-material-timepicker
                #plannedPicker4
                [format]="24"
                [defaultTime]="workdayForm.get('planned.shift2.stop')?.value === '00:00' ? '' : workdayForm.get('planned.shift2.stop')?.value"
                [minutesGap]="5"
                (closed)="calculatePlanHours()">
              </ngx-material-timepicker>
            </mat-form-field>
            <button mat-icon-button color="warn" (click)="resetPlannedTimes(6)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </ng-container>
    </ng-template>

    <!-- ACTUAL COLUMN TEMPLATE -->
    <ng-template #actualColumnTemplate let-row let-col="colDef">
      <!-- SHIFT 1 -->
      <ng-container *ngIf="row['shiftId'] === '1' && !isInTheFuture" [formGroupName]="'actual'">
        <div [formGroupName]="'shift1'">
          <div class="flex-row">
            <mat-form-field>
              <mat-label>{{ 'Start' | translate }}</mat-label>
              <input
                id="start1StartedAt"
                matInput
                readonly
                [ngxTimepicker]="picker"
                [format]="24"
                formControlName="start"/>
              <ngx-material-timepicker
                #picker
                [format]="24"
                [defaultTime]="workdayForm.get('actual.shift1.start')?.value"
                [minutesGap]="5"
                (closed)="calculatePlanHours()">
              </ngx-material-timepicker>
            </mat-form-field>
            <button mat-icon-button color="warn" (click)="resetActualTimes(1)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div class="flex-row">
            <mat-form-field>
              <mat-label>{{ 'Pause' | translate }}</mat-label>
              <input
                id="pause1Id"
                matInput
                readonly
                [ngxTimepicker]="pause1IdPicker"
                [format]="24"
                formControlName="pause"
                [min]="'00:00'"
                [max]="getMaxDifference(workdayForm.get('actual.shift1.start')?.value, workdayForm.get('actual.shift1.stop')?.value)" />
              <ngx-material-timepicker
                #pause1IdPicker
                [format]="24"
                [defaultTime]="workdayForm.get('actual.shift1.pause')?.value"
                [minutesGap]="5"
                (closed)="calculatePlanHours()">
              </ngx-material-timepicker>
            </mat-form-field>
            <button mat-icon-button color="warn" (click)="resetActualTimes(2)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div class="flex-row">
            <mat-form-field>
              <mat-label>{{ 'Stop' | translate }}</mat-label>
              <input
                id="stop1StoppedAt"
                matInput
                readonly
                [ngxTimepicker]="picker2"
                [format]="24"
                formControlName="stop" />
              <ngx-material-timepicker
                #picker2
                [format]="24"
                [defaultTime]="workdayForm.get('actual.shift1.stop')?.value"
                [minutesGap]="5"
                (closed)="calculatePlanHours()">
              </ngx-material-timepicker>
            </mat-form-field>
            <button mat-icon-button color="warn" (click)="resetActualTimes(3)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </ng-container>

      <!-- SHIFT 2 -->
      <ng-container *ngIf="row['shiftId'] === '2' && !isInTheFuture" [formGroupName]="'actual'">
        <div [formGroupName]="'shift2'">
          <div class="flex-row">
            <mat-form-field>
              <mat-label>{{ 'Start' | translate }}</mat-label>
              <input
                id="start2StartedAt"
                matInput
                readonly
                [ngxTimepicker]="picker3"
                [format]="24"
                formControlName="start" />
              <ngx-material-timepicker
                #picker3
                [format]="24"
                [defaultTime]="workdayForm.get('actual.shift2.start')?.value"
                [minutesGap]="5"
                (closed)="calculatePlanHours()">
              </ngx-material-timepicker>
            </mat-form-field>
            <button mat-icon-button color="warn" (click)="resetActualTimes(4)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div class="flex-row">
            <mat-form-field>
              <mat-label>{{ 'Pause' | translate }}</mat-label>
              <input
                id="pause2Id"
                matInput
                readonly
                [ngxTimepicker]="pause2IdPicker"
                [format]="24"
                formControlName="pause"
                [min]="'00:00'"
                [max]="getMaxDifference(workdayForm.get('actual.shift2.start')?.value, workdayForm.get('actual.shift2.stop')?.value)" />
              <ngx-material-timepicker
                #pause2IdPicker
                [format]="24"
                [defaultTime]="workdayForm.get('actual.shift2.pause')?.value"
                [minutesGap]="5"
                (closed)="calculatePlanHours()">
              </ngx-material-timepicker>
            </mat-form-field>
            <button mat-icon-button color="warn" (click)="resetActualTimes(5)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div class="flex-row">
            <mat-form-field>
              <mat-label>{{ 'Stop' | translate }}</mat-label>
              <input
                id="stop2StoppedAt"
                matInput
                readonly
                [ngxTimepicker]="picker4"
                [format]="24"
                formControlName="stop" />
              <ngx-material-timepicker
                #picker4
                [format]="24"
                [defaultTime]="workdayForm.get('actual.shift2.stop')?.value"
                [minutesGap]="5"
                (closed)="calculatePlanHours()">
              </ngx-material-timepicker>
            </mat-form-field>
            <button mat-icon-button color="warn" (click)="resetActualTimes(6)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </ng-container>

      <!-- SHIFT 3 -->
      <ng-container *ngIf="row['shiftId'] === '3' && data.assignedSiteModel.thirdShiftActive === true" [formGroupName]="'actual'">
        <div [formGroupName]="'shift3'">
          <div class="flex-row">
            <mat-form-field>
              <mat-label>{{ 'Start' | translate }}</mat-label>
              <input
                id="start3StartedAt"
                matInput
                readonly
                [ngxTimepicker]="picker5"
                [format]="24"
                formControlName="start" />
              <ngx-material-timepicker
                #picker5
                [format]="24"
                [defaultTime]="workdayForm.get('actual.shift3.start')?.value"
                [minutesGap]="5"
                (closed)="calculatePlanHours()">
              </ngx-material-timepicker>
            </mat-form-field>
            <button mat-icon-button color="warn" (click)="resetActualTimes(7)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div class="flex-row">
            <mat-form-field>
              <mat-label>{{ 'Pause' | translate }}</mat-label>
              <input
                id="pause3Id"
                matInput
                readonly
                [ngxTimepicker]="pause3IdPicker"
                [format]="24"
                formControlName="pause"
                [min]="'00:00'"
                [max]="getMaxDifference(workdayForm.get('actual.shift3.start')?.value, workdayForm.get('actual.shift3.stop')?.value)" />
              <ngx-material-timepicker
                #pause3IdPicker
                [format]="24"
                [defaultTime]="workdayForm.get('actual.shift3.pause')?.value"
                [minutesGap]="5"
                (closed)="calculatePlanHours()">
              </ngx-material-timepicker>
            </mat-form-field>
            <button mat-icon-button color="warn" (click)="resetActualTimes(8)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div class="flex-row">
            <mat-form-field>
              <mat-label>{{ 'Stop' | translate }}</mat-label>
              <input
                id="stop3StoppedAt"
                matInput
                readonly
                [ngxTimepicker]="picker6"
                [format]="24"
                formControlName="stop" />
              <ngx-material-timepicker
                #picker6
                [format]="24"
                [defaultTime]="workdayForm.get('actual.shift3.stop')?.value"
                [minutesGap]="5"
                (closed)="calculatePlanHours()">
              </ngx-material-timepicker>
            </mat-form-field>
            <button mat-icon-button color="warn" (click)="resetActualTimes(9)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </ng-container>

      <!-- SHIFT 4 -->
      <ng-container *ngIf="row['shiftId'] === '4' && data.assignedSiteModel.fourthShiftActive === true" [formGroupName]="'actual'">
        <div [formGroupName]="'shift4'">
          <div class="flex-row">
            <mat-form-field>
              <mat-label>{{ 'Start' | translate }}</mat-label>
              <input
                id="start4StartedAt"
                matInput
                readonly
                [ngxTimepicker]="picker7"
                [format]="24"
                formControlName="start"/>
              <ngx-material-timepicker
                #picker7
                [format]="24"
                [defaultTime]="workdayForm.get('actual.shift4.start')?.value"
                [minutesGap]="5"
                (closed)="calculatePlanHours()">
              </ngx-material-timepicker>
            </mat-form-field>
            <button mat-icon-button color="warn" (click)="resetActualTimes(10)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div class="flex-row">
            <mat-form-field>
              <mat-label>{{ 'Pause' | translate }}</mat-label>
              <input
                id="pause4Id"
                matInput
                readonly
                [ngxTimepicker]="pause4IdPicker"
                [format]="24"
                formControlName="pause"
                [min]="'00:00'"
                [max]="getMaxDifference(workdayForm.get('actual.shift4.start')?.value, workdayForm.get('actual.shift4.stop')?.value)" />
              <ngx-material-timepicker
                #pause4IdPicker
                [format]="24"
                [defaultTime]="workdayForm.get('actual.shift4.pause')?.value"
                [minutesGap]="5"
                (closed)="calculatePlanHours()">
              </ngx-material-timepicker>
            </mat-form-field>
            <button mat-icon-button color="warn" (click)="resetActualTimes(11)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div class="flex-row">
            <mat-form-field>
              <mat-label>{{ 'Stop' | translate }}</mat-label>
              <input
                id="stop4StoppedAt"
                matInput
                readonly
                [ngxTimepicker]="picker8"
                [format]="24"
                formControlName="stop"/>
              <ngx-material-timepicker
                #picker8
                [format]="24"
                [defaultTime]="workdayForm.get('actual.shift4.stop')?.value"
                [minutesGap]="5"
                (closed)="calculatePlanHours()">
              </ngx-material-timepicker>
            </mat-form-field>
            <button mat-icon-button color="warn" (click)="resetActualTimes(12)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </ng-container>

      <!-- SHIFT 5 -->
      <ng-container *ngIf="row['shiftId'] === '5' && data.assignedSiteModel.fifthShiftActive === true" [formGroupName]="'actual'">
        <div [formGroupName]="'shift5'">
          <div class="flex-row">
            <mat-form-field>
              <mat-label>{{ 'Start' | translate }}</mat-label>
              <input
                id="start5StartedAt"
                matInput
                readonly
                [ngxTimepicker]="picker9"
                [format]="24"
                formControlName="start" />
              <ngx-material-timepicker
                #picker9
                [format]="24"
                [defaultTime]="workdayForm.get('actual.shift5.start')?.value"
                [minutesGap]="5"
                (closed)="calculatePlanHours()">
              </ngx-material-timepicker>
            </mat-form-field>
            <button mat-icon-button color="warn" (click)="resetActualTimes(13)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div class="flex-row">
            <mat-form-field>
              <mat-label>{{ 'Pause' | translate }}</mat-label>
              <input
                id="pause5Id"
                matInput
                readonly
                [ngxTimepicker]="pause5IdPicker"
                [format]="24"
                formControlName="pause"
                [min]="'00:00'"
                [max]="getMaxDifference(workdayForm.get('actual.shift5.start')?.value, workdayForm.get('actual.shift5.stop')?.value)" />
              <ngx-material-timepicker
                #pause5IdPicker
                [format]="24"
                [defaultTime]="workdayForm.get('actual.shift5.pause')?.value"
                [minutesGap]="5"
                (closed)="calculatePlanHours()">
              </ngx-material-timepicker>
            </mat-form-field>
            <button mat-icon-button color="warn" (click)="resetActualTimes(14)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div class="flex-row">
            <mat-form-field>
              <mat-label>{{ 'Stop' | translate }}</mat-label>
              <input
                id="stop5StoppedAt"
                matInput
                readonly
                [ngxTimepicker]="picker10"
                [format]="24"
                formControlName="stop" />
              <ngx-material-timepicker
                #picker10
                [format]="24"
                [defaultTime]="workdayForm.get('actual.shift5.stop')?.value"
                [minutesGap]="5"
                (closed)="calculatePlanHours()">
              </ngx-material-timepicker>
            </mat-form-field>
            <button mat-icon-button color="warn" (click)="resetActualTimes(15)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </ng-container>
    </ng-template>

    <!-- READ-ONLY NUMBERS / OTHER FIELDS -->
    <br />
    <mat-form-field class="pr-2" *ngIf="!isInTheFuture">
      <mat-label>{{ 'Flex balance at start of day' | translate }}</mat-label>
      <input
        matInput
        type="text"
        id="flexToDate"
        readonly
        disabled
        [value]="data.planningPrDayModels.sumFlexStart.toFixed(2)" />
    </mat-form-field>

    <br />
    <mat-form-field class="pr-2">
      <mat-label>{{ 'Plan hours' | translate }}</mat-label>
      <input
        matInput
        type="number"
        id="planHours"
        formControlName="planHours"
        (change)="calculatePlanHours()" />
    </mat-form-field>

    <br />
    <mat-form-field class="pr-2" *ngIf="!isInTheFuture">
      <mat-label>{{ 'NettoHours' | translate }}</mat-label>
      <input
        matInput
        type="text"
        id="nettoHours"
        readonly
        disabled
        [value]="data.planningPrDayModels.actualHours.toFixed(2)" />
    </mat-form-field>

    <br />
    <mat-form-field class="pr-2" *ngIf="!isInTheFuture && data.planningPrDayModels.nettoHoursOverrideActive">
      <mat-label>{{ 'NettoHours override' | translate }}</mat-label>
      <input
        matInput
        type="number"
        id="nettoHoursOverride"
        formControlName="nettoHoursOverride"
        (change)="calculatePlanHours()" />
    </mat-form-field>

    <br *ngIf="data.planningPrDayModels.nettoHoursOverrideActive" />
    <mat-form-field class="pr-2" *ngIf="!isInTheFuture">
      <mat-label>{{ 'Flex' | translate }}</mat-label>
      <input
        matInput
        type="text"
        id="todaysFlex"
        readonly
        disabled
        [value]="todaysFlex.toFixed(2)" />
    </mat-form-field>

    <br />
    <mat-form-field class="pr-2" *ngIf="!isInTheFuture">
      <mat-label>{{ 'PaidOutFlex' | translate }}</mat-label>
      <input
        matInput
        type="text"
        id="paidOutFlex"
        formControlName="paidOutFlex"
        (change)="calculatePlanHours()" />
    </mat-form-field>

    <br />
    <mat-form-field class="pr-2" *ngIf="!isInTheFuture">
      <mat-label>{{ 'Flex balance to date' | translate }}</mat-label>
      <input
        matInput
        type="text"
        id="flexIncludingToday"
        readonly
        disabled
        [value]="data.planningPrDayModels.sumFlexEnd.toFixed(2)" />
    </mat-form-field>

    <br /><br />
    <p *ngIf="data.planningPrDayModels.workerComment">
      <strong>{{ 'CommentWorker' | translate }}:</strong>
      {{ data.planningPrDayModels.workerComment }}
    </p>

    <div formGroupName="flags">
      <ng-container *ngFor="let key of enumKeys">
        <ng-container *ngIf="key !== 'Blank' && key !== 'Care'">
          <mat-checkbox
            [formControlName]="key"
            (change)="onFlagChange(key)"
          >
            {{ key | translate }}
          </mat-checkbox>
        </ng-container>
      </ng-container>
    </div>


    <br /><br />
    <mat-form-field class="pr-2">
      <mat-label>{{ 'CommentOffice' | translate }}</mat-label>
      <input
        matInput
        type="text"
        id="CommentOffice"
        formControlName="commentOffice" />
    </mat-form-field>

    <br />
  </div>

  <div mat-dialog-actions class="d-flex flex-row justify-content-end">
    <button
      mat-raised-button
      mat-dialog-close
      id="cancelButton"
      (click)="onCancel()">
      {{ 'Cancel' | translate }}
    </button>

    <button
      id="saveButton"
      mat-raised-button
      color="accent"
      (click)="onUpdateWorkDayEntity()"
      [mat-dialog-close]="data">
      {{ 'Save' | translate }}
    </button>
  </div>
</form>
